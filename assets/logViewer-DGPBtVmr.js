var H=Object.defineProperty;var J=(o,e,i)=>e in o?H(o,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):o[e]=i;var k=(o,e,i)=>J(o,typeof e!="symbol"?e+"":e,i);import{w as M,x as q,a as A,u as I,g as K,e as Q,_ as X}from"./index-Bd1oa3-l.js";import{f as B,a6 as W,j as f,s as m,t as a,y as r,a2 as _,p as F,n as Y,r as T,a as N,a8 as Z,c as ee,I as te,u as U,k as oe,F as se,P as ae,v as y,x as b}from"./libs-DaDHWX8D.js";import{z as le,aJ as re,c as ne,M as L,v as ce,G as ie,F as ue,b as de,S as pe,H as he,T as fe,k as _e,n as me}from"./arcoDesign-DkbNuMsn.js";var h=(o=>(o.DEBUG="DEBUG",o.INFO="INFO",o.WARN="WARN",o.ERROR="ERROR",o.TRACE="TRACE",o))(h||{});const ge=["onClick"],we=B({__name:"copier",props:{text:{}},setup(o){const{t:e}=W(),i=async()=>{q(o.text),await new Promise(u=>setTimeout(u,3e3))};return(u,t)=>{const d=le,n=re,x=ne;return f(),m(M,{once:"","async-fn":i},{default:a(({run:R,loading:g})=>[r(x,{content:_(e)(g?"copier.copied":"copier.copy")},{default:a(()=>[F("span",{class:Y(g?"arco-typography-operation-copied":"arco-typography-operation-copy"),onClick:R},[g?(f(),m(d,{key:0})):(f(),m(n,{key:1}))],10,ge)]),_:2},1032,["content"])]),_:1})}}});class ye{constructor(e,i,u){k(this,"_isOpen",!1);k(this,"ws");k(this,"url");const t=new URL(e);this.url=new URL(A(`${t.protocol==="https:"?"wss":"ws"}://${t.host}${t.pathname}`,i)),this.url.searchParams.append("token",u)}get isOpen(){return this._isOpen}get State(){var e;return((e=this.ws)==null?void 0:e.readyState)??WebSocket.CLOSED}open(e,i,u){var t;try{(t=this.ws)==null||t.close(),this.url.searchParams.append("offset",e.toString()),this.ws=new WebSocket(this.url),this.ws.onopen=()=>{this._isOpen=!0},this.ws.onerror=d=>{u(new Error(`WebSocket error: ${d}`))},this.ws.onclose=()=>{this._isOpen=!1},this.ws.onmessage=d=>{try{const n=JSON.parse(d.data);n.success?i(n.data):u(new Error(`WebSocket error: ${n.message}`))}catch{}}}catch(d){return d instanceof Error&&u(d),!1}return!0}close(){var e;this._isOpen&&((e=this.ws)==null||e.close(),this.ws=void 0)}}class be extends ye{constructor(){const e=I();super(e.endpoint,"api/logs/stream",e.authToken)}}async function Re(){const o=I();await o.serverAvailable;const e=new URL(A(o.endpoint,"api/logs/history"),location.href);return fetch(e,{headers:K()}).then(i=>(o.assertResponseLogin(i),i.json()))}const Se={class:"hover-display-btn"},ve=B({__name:"logViewer",setup(o){const{t:e,d:i}=W(),u=T(!0),t=N({hideThreads:[],autoScroll:!0,autoRefresh:!1,showLevel:{[h.TRACE]:!1,[h.DEBUG]:!1,[h.INFO]:!0,[h.WARN]:!0,[h.ERROR]:!0}}),d=T([]),n=N([]);Z(Re,{onSuccess:c=>{n.splice(0,n.length),n.push(...c.data),u.value=!1;const l=new Set;c.data.forEach(p=>l.add(p.thread)),d.value=Array.from(l).map(p=>({value:p,tagProps:{color:O(p)}}))}});const x=ee(()=>n.filter(c=>t.showLevel[c.level]).filter(c=>!t.hideThreads.includes(c.thread))),R=T(),g=new be,$=async c=>{try{return c?g.open(n.length>0?n[n.length-1].offset:0,l=>{var p;n.push(l),t.autoScroll&&((p=R.value)==null||p.scrollIntoView({index:n.length-1,align:"bottom"}))},l=>{L.error(l.message),t.autoRefresh=!1}):(g.close(),!0)}catch(l){return l instanceof Error&&L.error(l.message),!1}},C=c=>{switch(c){case h.TRACE:return"blue";case h.WARN:return"orange";case h.ERROR:return"red";case h.DEBUG:case h.INFO:default:return"gray"}},O=c=>c.startsWith("virtual-")||c.startsWith("pool")||/Thread-[0-9]+/.test(c)?"gray":Q(c,["orange","orangered","red","blue"]);te(()=>{g.close()});const E=T(!0);return(c,l)=>{const p=ce,w=ie,z=ue,S=de,v=pe,D=he,G=fe,P=_e,j=me;return f(),m(v,{direction:"vertical",class:"container",size:"medium"},{default:a(()=>[r(D,{disabled:u.value,model:t,layout:"inline"},{default:a(()=>[r(w,{field:"autoRefresh",label:_(e)("page.settings.tab.info.log.enableAutoRefresh")},{default:a(()=>[r(p,{modelValue:t.autoRefresh,"onUpdate:modelValue":l[0]||(l[0]=s=>t.autoRefresh=s),"before-change":$},null,8,["modelValue"])]),_:1},8,["label"]),t.autoRefresh?(f(),m(w,{key:0,field:"autoScroll",label:_(e)("page.settings.tab.info.log.autoScorll")},{default:a(()=>[r(p,{modelValue:t.autoScroll,"onUpdate:modelValue":l[1]||(l[1]=s=>t.autoScroll=s)},null,8,["modelValue"])]),_:1},8,["label"])):U("",!0),r(w,{field:"showThreadName",label:_(e)("page.settings.tab.info.log.showThread")},{default:a(()=>[r(p,{modelValue:E.value,"onUpdate:modelValue":l[2]||(l[2]=s=>E.value=s)},null,8,["modelValue"])]),_:1},8,["label"]),r(w,{field:"hideThreads",label:_(e)("page.settings.tab.info.log.hideThreads")},{default:a(()=>[r(z,{modelValue:t.hideThreads,"onUpdate:modelValue":l[3]||(l[3]=s=>t.hideThreads=s),placeholder:_(e)("page.settings.tab.info.log.hideThreads.placeholder"),style:{width:"15rem"},multiple:"","max-tag-count":1,"allow-create":"",scrollbar:"",options:d.value,"virtual-list-props":{height:200,fixedSize:!0}},null,8,["modelValue","placeholder","options"])]),_:1},8,["label"]),r(w,{field:"hideThreads",label:_(e)("page.settings.tab.info.log.showLevel")},{default:a(()=>[r(v,null,{default:a(()=>[(f(!0),oe(se,null,ae(Object.keys(t.showLevel),s=>(f(),m(S,{key:s,checked:t.showLevel[s],"onUpdate:checked":V=>t.showLevel[s]=V,color:C(s),checkable:""},{default:a(()=>[y(b(s),1)]),_:2},1032,["checked","onUpdate:checked","color"]))),128))]),_:1})]),_:1},8,["label"])]),_:1},8,["disabled","model"]),r(j,{ref_key:"logList",ref:R,size:"small",loading:u.value,scrollbar:"","virtual-list-props":{height:650,buffer:50,fixedSize:!0},data:x.value},{item:a(({item:s,index:V})=>[(f(),m(P,{key:V},{default:a(()=>[r(v,{style:{display:"flex","justify-content":"space-between"},fill:"",class:"log-line-container"},{default:a(()=>[r(v,{class:"log-line"},{default:a(()=>[r(S,{class:"level-tag",color:C(s.level)},{default:a(()=>[y(b(s.level),1)]),_:2},1032,["color"]),r(S,null,{default:a(()=>[y(b(_(i)(s.time,"log")),1)]),_:2},1024),E.value?(f(),m(S,{key:0,color:O(s.thread)},{default:a(()=>[y(b(s.thread),1)]),_:2},1032,["color"])):U("",!0),r(G,{ellipsis:{rows:1,showTooltip:!0}},{default:a(()=>[y(b(s.content),1)]),_:2},1024)]),_:2},1024),F("div",Se,[r(we,{text:s.content},null,8,["text"])])]),_:2},1024)]),_:2},1024))]),_:1},8,["loading","data"])]),_:1})}}}),Ve=X(ve,[["__scopeId","data-v-3b1eb72d"]]);export{Ve as default};
